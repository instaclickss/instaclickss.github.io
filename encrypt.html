<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Encrypt Textarea Example</title>
</head>
<body>
  <textarea class="code" rows="5" cols="50"></textarea>
  <button id="encryptBtn">Encrypt</button>

  <script>
    const encoder = new TextEncoder();
    const decoder = new TextDecoder();

    // Derive key from password
    async function deriveKey(password) {
      const salt = encoder.encode("salt"); // replace with random salt if needed
      const baseKey = await crypto.subtle.importKey(
        "raw",
        encoder.encode(password),
        { name: "PBKDF2" },
        false,
        ["deriveKey"]
      );

      return crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt,
          iterations: 100000,
          hash: "SHA-256",
        },
        baseKey,
        { name: "AES-CBC", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    // Encrypt function
    async function encrypt(text, password) {
      const key = await deriveKey(password);
      const iv = crypto.getRandomValues(new Uint8Array(16));

      const encrypted = await crypto.subtle.encrypt(
        { name: "AES-CBC", iv },
        key,
        encoder.encode(text)
      );

      // Convert iv + encrypted data to hex
      return (
        Array.from(iv).map(b => b.toString(16).padStart(2, "0")).join("") +
        "_" +
        Array.from(new Uint8Array(encrypted))
          .map(b => b.toString(16).padStart(2, "0"))
          .join("")
      );
    }

    // Hook up the button
    document.getElementById("encryptBtn").addEventListener("click", async () => {
      const textarea = document.querySelector(".code");
      const text = textarea.value;
      const password = "mypassword123"; // ðŸ”‘ replace with user input if needed

      const encrypted = await encrypt(text, password);
      console.log(encrypted);
    });
  </script>
</body>
</html>
